# Source Mapping Injector

æºç æ˜ å°„æ³¨å…¥æ’ä»¶ï¼Œä¸ºå‰ç«¯ç»„ä»¶è‡ªåŠ¨æ·»åŠ æºç ä¿¡æ¯å±æ€§ï¼Œæ”¯æŒå¤šç§æ„å»ºå·¥å…·ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ æ”¯æŒå¤šç§æ„å»ºå·¥å…·ï¼šViteã€Webpackã€Rollupã€Next.jsã€Ice
- ğŸ“ æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼ï¼šJSXã€TSXã€Vueã€Svelte
- ğŸ¯ è‡ªåŠ¨ä¸ºç»„ä»¶æ·»åŠ æºç æ˜ å°„å±æ€§ï¼š`data-source-file`ã€`data-source-line`ã€`data-source-component`
- ğŸ”§ å¯é…ç½®çš„ç»„ä»¶åæå–è§„åˆ™
- ğŸ¨ åŸºäºASTè§£æï¼Œå®‰å…¨å¯é ï¼Œä¸ä¼šè¯¯å¤„ç†TypeScriptæ³›å‹æˆ–ç®­å¤´å‡½æ•°
- ğŸ“¦ çº¯æ„å»ºæ—¶æºç æ˜ å°„æ³¨å…¥ï¼Œæ— è¿è¡Œæ—¶å¼€é”€
- âš¡ æ™ºèƒ½æ£€æµ‹ï¼Œè‡ªåŠ¨åœ¨Reactæ’ä»¶ä¹‹å‰æ‰§è¡Œï¼Œå¤„ç†åŸå§‹JSXä»£ç 

## å®‰è£…

### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨å®‰è£…ï¼ˆæ¨èï¼‰

```bash
# å®‰è£…æ’ä»¶ï¼ˆBabelä¾èµ–ä¼šè‡ªåŠ¨å®‰è£…ï¼‰
npm install @ali/aone-super-source-mapping-injector
```

### æ–¹å¼äºŒï¼šå®¹å™¨ç¯å¢ƒå®‰è£…

**å®¹å™¨ç¯å¢ƒ**ï¼ˆå¦‚Dockerã€CI/CDç­‰ï¼‰ä¸­ï¼Œnpmä¼šè‡ªåŠ¨å®‰è£…Babelä¾èµ–ï¼š

```bash
# åœ¨å®¹å™¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼ˆæ¨èï¼‰
npm install @ali/aone-super-source-mapping-injector@0.1.0-beta.11 --no-save --registry=https://registry.anpm.alibaba-inc.com
```

**æ³¨æ„ï¼š** 
- npmä¼šè‡ªåŠ¨å®‰è£…æ’ä»¶çš„Babelä¾èµ–ï¼Œæ— éœ€æ‰‹åŠ¨å®‰è£…
- æ’ä»¶ä½¿ç”¨ESæ¨¡å—å¯¼å…¥ï¼Œå…¼å®¹ç°ä»£æ„å»ºç¯å¢ƒ
- æ”¯æŒå®¹å™¨ç¯å¢ƒä¸­çš„è‡ªåŠ¨ä¾èµ–è§£æ

## ä½¿ç”¨æ–¹å¼

### Vite æ’ä»¶

```js
// vite.config.js
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import sourceMappingInjector from '@ali/aone-super-source-mapping-injector';

export default defineConfig({
  plugins: [
    // é‡è¦ï¼šsource-mappingæ’ä»¶å¿…é¡»åœ¨reactæ’ä»¶ä¹‹å‰æ‰§è¡Œ
    // æ’ä»¶ä¼šè‡ªåŠ¨ä½¿ç”¨ enforce: 'pre' ç¡®ä¿æ‰§è¡Œé¡ºåº
    sourceMappingInjector({
      enabled: true,
      getComponentName: (fileName) => {
        // è‡ªå®šä¹‰ç»„ä»¶åæå–é€»è¾‘
        return fileName.split('/').pop().replace(/\.[^/.]+$/, '');
      },
      includeExtensions: ['.jsx', '.tsx'],
      excludePatterns: ['node_modules', 'dist']
    }),
    react() // Reactæ’ä»¶ä¼šè‡ªåŠ¨åœ¨source-mappingä¹‹åæ‰§è¡Œ
  ]
});
```

**é‡è¦è¯´æ˜ï¼š**
- æ’ä»¶ä¼šè‡ªåŠ¨ä½¿ç”¨ `enforce: 'pre'` ç¡®ä¿åœ¨Reactæ’ä»¶ä¹‹å‰æ‰§è¡Œ
- è¿™æ ·å¯ä»¥ç›´æ¥å¤„ç†åŸå§‹JSXä»£ç ï¼Œé¿å…å¤æ‚çš„jsxDEVå¤„ç†
- åŸºäºASTè§£æï¼Œå®‰å…¨å¯é ï¼Œä¸ä¼šè¯¯å¤„ç†TypeScriptæ³›å‹æˆ–ç®­å¤´å‡½æ•°

### Webpack æ’ä»¶

```js
// webpack.config.js
const { webpackAdapter } = require('@ali/aone-super-source-mapping-injector');

module.exports = {
  plugins: [
    webpackAdapter({
      enabled: process.env.NODE_ENV === 'development'
    })
  ]
};
```

### Rollup æ’ä»¶

```js
// rollup.config.js
import { rollupAdapter } from '@ali/aone-super-source-mapping-injector';

export default {
  plugins: [
    rollupAdapter({
      enabled: true
    })
  ]
};
```


### ç±»æ–¹å¼ä½¿ç”¨

```js
import { SourceMappingInjector } from '@ali/aone-super-source-mapping-injector';

const injector = new SourceMappingInjector({
  enabled: true,
  getComponentName: (fileName) => {
    // è‡ªå®šä¹‰ç»„ä»¶åæå–
    return fileName.split('/').pop().replace(/\.[^/.]+$/, '');
  }
});

// è½¬æ¢ä»£ç 
const transformedCode = injector.transform(originalCode, 'src/Button.jsx');

// ç”Ÿæˆå±æ€§
const attributes = injector.generateAttributes('src/Button.jsx', 10);
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸå§‹ä»£ç è½¬æ¢ç¤ºä¾‹

**åŸå§‹ JSX ä»£ç ï¼š**
```jsx
import React, { useState } from 'react';

function Calculator() {
  const [num1, setNum1] = useState<string>('');
  const [num2, setNum2] = useState<number>(0);
  
  return (
    <div className="calculator">
      <h1>åŠ æ³•è®¡ç®—å™¨</h1>
      <p>è¾“å…¥ä¸¤ä¸ªæ•°å­—è¿›è¡ŒåŠ æ³•è¿ç®—</p>
      <button onClick={(e) => setNum1(e.target.value)}>
        è®¡ç®—
      </button>
    </div>
  );
}

export default Calculator;
```

**æ’ä»¶è½¬æ¢åçš„ä»£ç ï¼š**
```jsx
import React, { useState } from 'react';

function Calculator() {
  const [num1, setNum1] = useState<string>('');  // âœ… TypeScriptæ³›å‹æœªè¢«è¯¯å¤„ç†
  const [num2, setNum2] = useState<number>(0);   // âœ… TypeScriptæ³›å‹æœªè¢«è¯¯å¤„ç†
  
  return (
    <div className="calculator" data-source-file="src/Calculator.tsx" data-source-line="6" data-source-component="Calculator">
      <h1 data-source-file="src/Calculator.tsx" data-source-line="7" data-source-component="Calculator">åŠ æ³•è®¡ç®—å™¨</h1>
      <p data-source-file="src/Calculator.tsx" data-source-line="8" data-source-component="Calculator">è¾“å…¥ä¸¤ä¸ªæ•°å­—è¿›è¡ŒåŠ æ³•è¿ç®—</p>
      <button onClick={(e) => setNum1(e.target.value)} data-source-file="src/Calculator.tsx" data-source-line="9" data-source-component="Calculator">
        è®¡ç®—
      </button>
    </div>
  );
}

export default Calculator;
```

**å…³é”®ä¼˜åŠ¿ï¼š**
- âœ… TypeScriptæ³›å‹ `useState<string>` å’Œ `useState<number>` æœªè¢«è¯¯å¤„ç†
- âœ… ç®­å¤´å‡½æ•° `(e) => setNum1(e.target.value)` æœªè¢«è¯¯å¤„ç†
- âœ… åªæœ‰çœŸæ­£çš„JSXå…ƒç´ è¢«æ·»åŠ äº†æºç æ˜ å°„å±æ€§
- âœ… åŸºäºASTè§£æï¼Œå®‰å…¨å¯é 

### ç¼–ç¨‹å¼ä½¿ç”¨ç¤ºä¾‹

```js
import { SourceMappingInjector, transformCode } from '@ali/aone-super-source-mapping-injector';

// æ–¹å¼1ï¼šä½¿ç”¨ç±»
const injector = new SourceMappingInjector({
  enabled: true,
  getComponentName: (fileName) => {
    const name = fileName.split('/').pop().replace(/\.[^/.]+$/, '');
    return name.charAt(0).toUpperCase() + name.slice(1);
  }
});

const result = injector.transform(originalJSX, 'src/App.jsx');
console.log('è½¬æ¢ç»“æœ:', result);

// æ–¹å¼2ï¼šç›´æ¥ä½¿ç”¨å‡½æ•°
const result2 = transformCode(originalJSX, 'src/App.jsx', {
  enabled: true
});

// æ–¹å¼3ï¼šç”Ÿæˆå±æ€§å­—ç¬¦ä¸²
const attributes = injector.generateAttributes('src/Button.jsx', 5);
console.log('ç”Ÿæˆçš„å±æ€§:', attributes);
// è¾“å‡º: data-source-file="src/Button.jsx" data-source-line="5" data-source-component="Button"

// æ–¹å¼4ï¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦åº”è¯¥è¢«å¤„ç†
const shouldProcess = injector.shouldProcess('src/Button.jsx');
console.log('æ˜¯å¦å¤„ç†æ–‡ä»¶:', shouldProcess); // true
```

## é…ç½®é€‰é¡¹

| é€‰é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|------|------|--------|------|
| `enabled` | `boolean` | `true` | æ˜¯å¦å¯ç”¨æºç æ˜ å°„æ³¨å…¥ |
| `getComponentName` | `function` | è‡ªåŠ¨æå– | è‡ªå®šä¹‰ç»„ä»¶åæå–å‡½æ•° |
| `includeExtensions` | `string[]` | `['.jsx', '.tsx', '.js', '.ts', '.vue', '.svelte']` | éœ€è¦å¤„ç†çš„æ–‡ä»¶æ‰©å±•å |
| `excludePatterns` | `string[]` | `['node_modules', '.git', 'dist', 'build']` | æ’é™¤çš„æ–‡ä»¶è·¯å¾„æ¨¡å¼ |
| `devOnly` | `boolean` | `false` | æ˜¯å¦ä»…åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯ç”¨ |

## æŠ€æœ¯å®ç°

### ASTè§£ææŠ€æœ¯
- ä½¿ç”¨ `@babel/parser` è§£æä»£ç ä¸ºAST
- ä½¿ç”¨ `@babel/traverse` éå†JSXå…ƒç´ 
- ä½¿ç”¨ `@babel/generator` ç”Ÿæˆè½¬æ¢åçš„ä»£ç 
- å®Œå…¨é¿å…æ­£åˆ™è¡¨è¾¾å¼çš„è¯¯åŒ¹é…é—®é¢˜

### æ’ä»¶æ‰§è¡Œé¡ºåº
- è‡ªåŠ¨ä½¿ç”¨ `enforce: 'pre'` ç¡®ä¿åœ¨Reactæ’ä»¶ä¹‹å‰æ‰§è¡Œ
- ç›´æ¥å¤„ç†åŸå§‹JSXä»£ç ï¼Œé¿å…å¤æ‚çš„jsxDEVå¤„ç†
- æ”¯æŒTypeScriptã€JSXã€è£…é¥°å™¨ç­‰è¯­æ³•

### å®‰å…¨ç‰¹æ€§
- âœ… ä¸ä¼šè¯¯å¤„ç†TypeScriptæ³›å‹ï¼š`useState<string>`
- âœ… ä¸ä¼šè¯¯å¤„ç†ç®­å¤´å‡½æ•°ï¼š`(e) => setValue(e.target.value)`
- âœ… ä¸ä¼šè¯¯å¤„ç†æ¯”è¾ƒæ“ä½œç¬¦ï¼š`if (a > b)`
- âœ… ä¸ä¼šè¯¯å¤„ç†æ¨¡æ¿å­—ç¬¦ä¸²ï¼š`<${variable}>`
- âœ… åªå¤„ç†çœŸæ­£çš„JSXå…ƒç´ 

## ç”Ÿæˆçš„å±æ€§

æ’ä»¶ä¼šè‡ªåŠ¨ä¸ºç»„ä»¶æ·»åŠ ä»¥ä¸‹å±æ€§ï¼š

```html
<div 
  data-source-file="src/components/Button.jsx"
  data-source-line="15"
  data-source-component="Button"
>
  Hello World
</div>
```

## ç”Ÿæˆçš„å±æ€§è¯´æ˜

æ’ä»¶ä¼šè‡ªåŠ¨ä¸ºç»„ä»¶æ·»åŠ ä»¥ä¸‹å±æ€§ï¼Œè¿™äº›å±æ€§å¯ä»¥è¢«å…¶ä»–å·¥å…·ï¼ˆå¦‚ DOM Inspectorï¼‰è¯»å–å’Œä½¿ç”¨ï¼š

```html
<div 
  data-source-file="src/components/Button.jsx"
  data-source-line="15"
  data-source-component="Button"
>
  Hello World
</div>
```

è¿™äº›å±æ€§å¯ä»¥ç”¨äºï¼š
- æºç å®šä½å’Œè°ƒè¯•
- ä¸å…¶ä»–å¼€å‘å·¥å…·é›†æˆ
- è‡ªåŠ¨åŒ–æµ‹è¯•ä¸­çš„å…ƒç´ å®šä½

## æ”¯æŒçš„æ¡†æ¶

- âœ… React (JSX/TSX)
- âœ… Vue (.vue æ–‡ä»¶)
- âœ… Svelte (.svelte æ–‡ä»¶)
- âœ… åŸç”Ÿ HTML/JS

## æ”¯æŒçš„æ„å»ºå·¥å…·

- âœ… Vite
- âœ… Webpack
- âœ… Rollup
- âœ… Next.js
- âœ… Ice

## ä¾èµ–è¦æ±‚

æ’ä»¶ä½¿ç”¨æ··åˆä¾èµ–ç­–ç•¥ï¼š

```json
{
  "dependencies": {
    "@babel/parser": "^7.0.0",
    "@babel/traverse": "^7.0.0", 
    "@babel/generator": "^7.0.0",
    "@babel/types": "^7.0.0"
  },
  "peerDependencies": {
    "@babel/parser": "^7.0.0",
    "@babel/traverse": "^7.0.0", 
    "@babel/generator": "^7.0.0",
    "@babel/types": "^7.0.0"
  }
}
```

**æ··åˆç­–ç•¥çš„ä¼˜åŠ¿ï¼š**
- âœ… **å¼€ç®±å³ç”¨**ï¼šBabelä¾èµ–ä¼šè‡ªåŠ¨å®‰è£…ï¼Œç”¨æˆ·æ— éœ€æ‰‹åŠ¨å®‰è£…
- âœ… **ç‰ˆæœ¬å…¼å®¹**ï¼šå¦‚æœé¡¹ç›®å·²æœ‰Babelä¾èµ–ï¼Œnpmä¼šä¼˜å…ˆä½¿ç”¨é¡¹ç›®ç‰ˆæœ¬
- âœ… **é¿å…å†²çª**ï¼špeerDependenciesç¡®ä¿ç‰ˆæœ¬å…¼å®¹æ€§
- âœ… **æœ€ä½³ä½“éªŒ**ï¼šæ—¢ç®€å•åˆçµæ´»

## å¼€å‘

```bash
# å®‰è£…ä¾èµ–
npm install

# å¼€å‘æ¨¡å¼
npm run start

# æ„å»º
npm run build
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ’ä»¶æ²¡æœ‰ç”Ÿæ•ˆ**
   - ç¡®ä¿æ’ä»¶åœ¨Reactæ’ä»¶ä¹‹å‰æ‰§è¡Œ
   - æ£€æŸ¥æ–‡ä»¶æ‰©å±•åæ˜¯å¦åœ¨ `includeExtensions` ä¸­
   - ç¡®è®¤æ–‡ä»¶è·¯å¾„ä¸åœ¨ `excludePatterns` ä¸­

2. **TypeScriptæ³›å‹è¢«è¯¯å¤„ç†**
   - æ–°ç‰ˆæœ¬åŸºäºASTè§£æï¼Œä¸ä¼šå‡ºç°æ­¤é—®é¢˜
   - å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥Babelä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…

3. **æ„å»ºå¤±è´¥**
   - æ£€æŸ¥æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
   - ç¡®è®¤Babelä¾èµ–ç‰ˆæœ¬å…¼å®¹æ€§
   - æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

4. **Babelä¾èµ–æœªæ‰¾åˆ° / traverse is not a function**
   - **åŸå› **ï¼šé€šå¸¸æ˜¯å› ä¸ºnpmç‰ˆæœ¬è¿‡ä½æˆ–ä¾èµ–å®‰è£…ä¸å®Œæ•´
   - **è§£å†³æ–¹æ¡ˆ**ï¼š
     ```bash
     # æ–¹å¼1ï¼šé‡æ–°å®‰è£…æ’ä»¶ï¼ˆæ¨èï¼‰
     npm install @ali/aone-super-source-mapping-injector@0.1.0-beta.11 --no-save --registry=https://registry.anpm.alibaba-inc.com
     
     # æ–¹å¼2ï¼šæ£€æŸ¥ä¾èµ–å®‰è£…çŠ¶æ€
     npm ls @babel/parser
     ls node_modules/@babel/
     
     # æ–¹å¼3ï¼šå¦‚æœä»æœ‰é—®é¢˜ï¼Œæ‰‹åŠ¨å®‰è£…Babelä¾èµ–
     npm install @babel/parser @babel/traverse @babel/generator @babel/types --no-save
     ```
   - **æ’ä»¶æ”¯æŒ**ï¼šæ’ä»¶ä½¿ç”¨ESæ¨¡å—å¯¼å…¥ï¼Œnpmä¼šè‡ªåŠ¨å¤„ç†ä¾èµ–å®‰è£…

### è°ƒè¯•æ¨¡å¼

```js
// å¯ç”¨è¯¦ç»†æ—¥å¿—
sourceMappingInjector({
  enabled: true,
  verbose: true  // æ˜¾ç¤ºè¯¦ç»†çš„å¤„ç†æ—¥å¿—
})
```
