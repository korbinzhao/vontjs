# å¼€å‘ç¯å¢ƒçƒ­æ›´æ–°æŠ€æœ¯æ–¹æ¡ˆ

## ä¸€ã€å½“å‰æœºåˆ¶åˆ†æ

### ç°çŠ¶é—®é¢˜

å½“å‰çš„å¼€å‘æœºåˆ¶å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **å®Œæ•´æ„å»ºå¼€é”€å¤§**ï¼šæ¯æ¬¡å¯åŠ¨ `npm run dev` éƒ½éœ€è¦å®Œæ•´æ„å»ºæ•´ä¸ªé¡¹ç›®ï¼ˆå‰ç«¯ + åç«¯ + APIï¼‰
   - ä½¿ç”¨ Vite æ„å»ºå‰ç«¯ï¼ˆç”Ÿäº§æ„å»ºï¼‰
   - ä½¿ç”¨ esbuild æ„å»ºåç«¯æœåŠ¡å™¨ä»£ç 
   - ä½¿ç”¨ esbuild ç¼–è¯‘æ‰€æœ‰ API æ¨¡å—
   - æ„å»ºæ—¶é—´éšé¡¹ç›®è§„æ¨¡å¢é•¿è€Œå¢åŠ 

2. **æ— çƒ­æ›´æ–°æœºåˆ¶**ï¼šä¿®æ”¹ä»»ä½•ä»£ç éƒ½éœ€è¦æ‰‹åŠ¨é‡å¯æœåŠ¡å™¨
   - ä¿®æ”¹ server ä»£ç éœ€è¦é‡å¯
   - ä¿®æ”¹ API ä»£ç éœ€è¦é‡å¯
   - ä¿®æ”¹ client ä»£ç éœ€è¦é‡å¯
   - å¼€å‘ä½“éªŒå·®ï¼Œæ•ˆç‡ä½

3. **å¼€å‘ç¯å¢ƒè¯¯ç”¨ç”Ÿäº§æ„å»º**ï¼š
   - å¼€å‘æ¨¡å¼ä¸‹è¿è¡Œç¼–è¯‘åçš„ä»£ç ï¼Œè€Œä¸æ˜¯æºä»£ç 
   - å¤±å»äº†å¼€å‘ç¯å¢ƒçš„ä¼˜åŠ¿ï¼ˆå¦‚æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€æºç æ˜ å°„ç­‰ï¼‰
   - Vite çš„å¼€å‘æœåŠ¡å™¨åŠŸèƒ½æœªè¢«åˆ©ç”¨

### æ¶æ„ç¼ºé™·

```
ç°çŠ¶æµç¨‹ï¼š
npm run dev 
  â†’ npm run build (å®Œæ•´æ„å»º)
    â†’ Vite ç”Ÿäº§æ„å»ºå‰ç«¯ (æ…¢)
    â†’ esbuild æ„å»ºåç«¯ (å¿«ä½†ä¸å¿…è¦)
    â†’ esbuild ç¼–è¯‘ API (å¿«ä½†ä¸å¿…è¦)
  â†’ å¯åŠ¨ dist/server/index.js (ç¼–è¯‘åä»£ç )
```

## äºŒã€æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

### æ ¸å¿ƒæ€è·¯

é‡‡ç”¨çœŸæ­£çš„å¼€å‘æ¨¡å¼ï¼Œåˆ©ç”¨ç°æœ‰å·¥å…·çš„å¼€å‘ç‰¹æ€§ï¼š

1. **å‰ç«¯**ï¼šåˆ©ç”¨ Vite çš„å¼€å‘æœåŠ¡å™¨ï¼ˆHMR + å¿«é€Ÿå†·å¯åŠ¨ï¼‰
2. **åç«¯**ï¼šä½¿ç”¨ tsx/nodemon ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨é‡å¯
3. **API**ï¼šé€šè¿‡åç«¯é‡å¯æœºåˆ¶è‡ªåŠ¨é‡æ–°åŠ è½½

### ç›®æ ‡æ¶æ„

```
æ–°æµç¨‹ï¼š
npm run dev
  â†’ å¯åŠ¨ Vite Dev Server (ä¸­é—´ä»¶æ¨¡å¼)
  â†’ ä½¿ç”¨ tsx + nodemon å¯åŠ¨åç«¯æºç 
    â†’ ç›‘å¬ src/server å’Œ src/api æ–‡ä»¶å˜åŒ–
    â†’ è‡ªåŠ¨é‡å¯åç«¯è¿›ç¨‹
  â†’ Vite HMR å¤„ç†å‰ç«¯çƒ­æ›´æ–°
```

### æŠ€æœ¯é€‰å‹

1. **å‰ç«¯çƒ­æ›´æ–°**ï¼šVite å†…ç½® HMR
   - React Fast Refresh æ”¯æŒ
   - CSS çƒ­æ›´æ–°
   - ä¾èµ–é¢„æ„å»ºç¼“å­˜

2. **åç«¯çƒ­æ›´æ–°**ï¼štsx + nodemon
   - `tsx`ï¼šç›´æ¥è¿è¡Œ TypeScript ä»£ç ï¼ˆåŸºäº esbuildï¼‰
   - `nodemon`ï¼šç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨é‡å¯è¿›ç¨‹

3. **é›†æˆæ–¹å¼**ï¼š
   - Vite ä»¥ä¸­é—´ä»¶æ¨¡å¼é›†æˆåˆ° Koa
   - ä½¿ç”¨ `src/server/dev.ts` ä½œä¸ºå¼€å‘æœåŠ¡å™¨å…¥å£

### ä¼˜åŠ¿åˆ†æ

| æ–¹é¢ | ç°çŠ¶ | æ–°æ–¹æ¡ˆ |
|------|------|--------|
| å¯åŠ¨æ—¶é—´ | éœ€è¦å®Œæ•´æ„å»º (10-30s) | å‡ ä¹å³æ—¶ (<2s) |
| å‰ç«¯çƒ­æ›´æ–° | âŒ éœ€è¦é‡å¯ | âœ… Vite HMR |
| åç«¯çƒ­æ›´æ–° | âŒ éœ€è¦é‡å¯ | âœ… è‡ªåŠ¨é‡å¯ |
| API çƒ­æ›´æ–° | âŒ éœ€è¦é‡å¯ | âœ… è‡ªåŠ¨é‡å¯ |
| æºç è°ƒè¯• | âš ï¸ ç¼–è¯‘åä»£ç  | âœ… ç›´æ¥è°ƒè¯•æºç  |
| é”™è¯¯æç¤º | âš ï¸ ä¸€èˆ¬ | âœ… è¯¦ç»†çš„å¼€å‘é”™è¯¯ä¿¡æ¯ |
| å¼€å‘ä½“éªŒ | âš ï¸ è¾ƒå·® | âœ… ä¼˜ç§€ |

## ä¸‰ã€å®ç°æ–¹æ¡ˆ

### 3.1 ä¾èµ–å®‰è£…

éœ€è¦å®‰è£…ä»¥ä¸‹å¼€å‘ä¾èµ–ï¼š

```bash
npm install --save-dev nodemon concurrently chokidar
```

- `nodemon`: ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨é‡å¯
- `concurrently`: åŒæ—¶è¿è¡Œå¤šä¸ªå‘½ä»¤ï¼ˆå¯é€‰ï¼Œç”¨äºæ›´å¥½çš„æ—¥å¿—ï¼‰
- `chokidar`: æ–‡ä»¶ç›‘å¬ï¼ˆtsx å†…ç½®ï¼Œä½†å¯ä»¥æ˜¾å¼ç”¨äºè‡ªå®šä¹‰ç›‘å¬ï¼‰

### 3.2 æ”¹é€  src/server/dev.ts

å½“å‰ `src/server/dev.ts` å·²ç»å®ç°äº† Vite ä¸­é—´ä»¶é›†æˆï¼Œéœ€è¦ä¼˜åŒ–ï¼š

1. ç§»é™¤ä¸å¿…è¦çš„ SSR é€»è¾‘
2. ä¼˜åŒ– Vite ä¸­é—´ä»¶é…ç½®
3. æ·»åŠ  API è·¯ç”±çƒ­é‡è½½æœºåˆ¶

### 3.3 åˆ›å»º nodemon é…ç½®

åˆ›å»º `nodemon.json` é…ç½®æ–‡ä»¶ï¼š

```json
{
  "watch": ["src/server", "src/api"],
  "ext": "ts,tsx,js,jsx",
  "ignore": ["src/client.tsx", "src/pages/**/*", "src/styles/**/*"],
  "exec": "tsx src/server/dev.ts",
  "delay": "1000"
}
```

### 3.4 æ”¹é€ å¼€å‘è„šæœ¬

ä¿®æ”¹ `scripts/dev.js` æˆ–ç›´æ¥åœ¨ `package.json` ä¸­é…ç½®ï¼š

**æ–¹æ¡ˆ Aï¼šç®€å•æ–¹æ¡ˆï¼ˆæ¨èï¼‰**
```json
{
  "scripts": {
    "dev": "nodemon --exec tsx src/server/dev.ts",
    "dev:verbose": "nodemon --exec tsx src/server/dev.ts --verbose"
  }
}
```

**æ–¹æ¡ˆ Bï¼šä½¿ç”¨é…ç½®æ–‡ä»¶**
```json
{
  "scripts": {
    "dev": "nodemon",
    "dev:verbose": "nodemon --verbose"
  }
}
```

### 3.5 API è·¯ç”±çƒ­é‡è½½

åœ¨ `src/server/dev.ts` ä¸­æ·»åŠ  API è·¯ç”±é‡è½½æœºåˆ¶ï¼š

```typescript
// ä½¿ç”¨ chokidar ç›‘å¬ API æ–‡ä»¶å˜åŒ–
import chokidar from 'chokidar';

// ç›‘å¬ API ç›®å½•
const watcher = chokidar.watch('src/api/**/*.ts', {
  ignored: /(^|[\/\\])\../, // å¿½ç•¥éšè—æ–‡ä»¶
  persistent: true
});

watcher.on('change', async (path) => {
  console.log(`ğŸ”„ API file changed: ${path}`);
  // é‡æ–°æ‰«æè·¯ç”±
  await registry.scan();
  // é‡æ–°æ³¨å†Œè·¯ç”±ï¼ˆéœ€è¦æ¸…é™¤æ—§è·¯ç”±ï¼‰
  // è¿™éƒ¨åˆ†éœ€è¦ä¿®æ”¹ registerApiRoutes æ”¯æŒåŠ¨æ€æ›´æ–°
});
```

### 3.6 æ”¹è¿›è·¯ç”±æ³¨å†Œæœºåˆ¶

ä¿®æ”¹ `src/server/app.ts` ä½¿å…¶æ”¯æŒåŠ¨æ€è·¯ç”±æ›´æ–°ï¼š

```typescript
// å¯¼å‡º router å®ä¾‹ï¼Œä¾¿äºåŠ¨æ€æ›´æ–°
export function registerApiRoutes(
  app: Koa, 
  routes: RouteConfig[],
  existingRouter?: Router
): Router {
  const router = existingRouter || new Router();
  
  if (existingRouter) {
    // æ¸…é™¤ç°æœ‰è·¯ç”±
    router.stack = [];
  }
  
  for (const route of routes) {
    const method = route.method.toLowerCase() as 'get' | 'post' | 'put' | 'delete' | 'patch' | 'options';
    const handlers = [...route.middleware, route.handler];
    router[method](route.path, ...handlers);
    console.log(`âœ“ ${route.method.padEnd(6)} ${route.path}`);
  }
  
  // åªåœ¨ç¬¬ä¸€æ¬¡æ³¨å†Œæ—¶æ·»åŠ åˆ° app
  if (!existingRouter) {
    app.use(router.routes());
    app.use(router.allowedMethods());
  }
  
  return router;
}
```

## å››ã€ç”Ÿäº§æ„å»ºä¿æŒä¸å˜

ç”Ÿäº§æ„å»ºæµç¨‹ä¿æŒç°æœ‰çš„ `scripts/build.js` ä¸å˜ï¼š

```
npm run build â†’ å®Œæ•´æ„å»º â†’ dist/
npm start â†’ è¿è¡Œç”Ÿäº§ä»£ç 
```

## äº”ã€å®æ–½æ­¥éª¤

1. âœ… åˆ†æç°çŠ¶ï¼Œåˆ¶å®šæ–¹æ¡ˆ
2. â¬œ å®‰è£…å¿…è¦çš„ä¾èµ–
3. â¬œ åˆ›å»º nodemon é…ç½®æ–‡ä»¶
4. â¬œ æ”¹é€  `src/server/dev.ts`ï¼ˆä¼˜åŒ– Vite é›†æˆï¼‰
5. â¬œ ä¿®æ”¹ `src/server/app.ts`ï¼ˆæ”¯æŒåŠ¨æ€è·¯ç”±ï¼‰
6. â¬œ æ›´æ–° `package.json` è„šæœ¬
7. â¬œ åˆ é™¤æˆ–é‡å‘½åæ—§çš„ `scripts/dev.js`
8. â¬œ æµ‹è¯•å‰ç«¯çƒ­æ›´æ–°
9. â¬œ æµ‹è¯•åç«¯çƒ­é‡å¯
10. â¬œ æµ‹è¯• API çƒ­é‡å¯
11. â¬œ æ–‡æ¡£æ›´æ–°

## å…­ã€é¢„æœŸæ•ˆæœ

### å¯åŠ¨é€Ÿåº¦

- **ç°çŠ¶**ï¼š10-30 ç§’ï¼ˆå–å†³äºé¡¹ç›®å¤§å°ï¼‰
- **ä¼˜åŒ–å**ï¼š< 2 ç§’

### å¼€å‘ä½“éªŒ

- **å‰ç«¯ä¿®æ”¹**ï¼šä¿å­˜åç«‹å³çƒ­æ›´æ–°ï¼Œæ— åˆ·æ–°ï¼ˆReact Fast Refreshï¼‰
- **æ ·å¼ä¿®æ”¹**ï¼šä¿å­˜åç«‹å³æ›´æ–°ï¼Œæ— åˆ·æ–°
- **åç«¯ä¿®æ”¹**ï¼šä¿å­˜å 1-2 ç§’è‡ªåŠ¨é‡å¯æœåŠ¡å™¨
- **API ä¿®æ”¹**ï¼šä¿å­˜å 1-2 ç§’è‡ªåŠ¨é‡å¯æœåŠ¡å™¨

### é”™è¯¯æç¤º

- **å‰ç«¯**ï¼šVite æä¾›è¯¦ç»†çš„é”™è¯¯è¦†ç›–å±‚
- **åç«¯**ï¼šTypeScript ç±»å‹é”™è¯¯åœ¨ç»ˆç«¯å®æ—¶æ˜¾ç¤º
- **API**ï¼šè·¯ç”±æ³¨å†Œé”™è¯¯å®æ—¶åé¦ˆ

## ä¸ƒã€é£é™©ä¸æ³¨æ„äº‹é¡¹

### é£é™©

1. **åç«¯é‡å¯ä¼šæ–­å¼€ç°æœ‰è¿æ¥**
   - å½±å“ï¼šWebSocket è¿æ¥ã€é•¿è½®è¯¢ç­‰ä¼šä¸­æ–­
   - ç¼“è§£ï¼šä½¿ç”¨å‰ç«¯é‡è¿æœºåˆ¶

2. **å†…å­˜æ³„æ¼é£é™©**
   - é¢‘ç¹é‡å¯å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
   - ç¼“è§£ï¼šä½¿ç”¨ nodemon çš„è¿›ç¨‹é‡å¯æœºåˆ¶

### æ³¨æ„äº‹é¡¹

1. **ä¸è¦åœ¨å¼€å‘æ¨¡å¼ä¸‹è¿›è¡Œæ€§èƒ½æµ‹è¯•**
   - tsx æ¯”ç¼–è¯‘åçš„ä»£ç æ…¢
   - Vite å¼€å‘æ¨¡å¼ä¼šæœ‰é¢å¤–å¼€é”€

2. **ç”Ÿäº§éƒ¨ç½²ä»ä½¿ç”¨ç¼–è¯‘åä»£ç **
   - `npm run build` æ„å»ºä¼˜åŒ–åçš„ä»£ç 
   - `npm start` è¿è¡Œç”Ÿäº§æœåŠ¡å™¨

3. **ç¯å¢ƒå˜é‡åŒºåˆ†**
   - å¼€å‘ï¼š`NODE_ENV=development`
   - ç”Ÿäº§ï¼š`NODE_ENV=production`

## å…«ã€åç»­ä¼˜åŒ–æ–¹å‘

1. **å¢é‡ API è·¯ç”±æ›´æ–°**
   - ä»…é‡æ–°åŠ è½½å˜åŒ–çš„ API æ¨¡å—
   - é¿å…å…¨é‡é‡å¯

2. **å‰åç«¯é€šä¿¡ä¼˜åŒ–**
   - åç«¯é‡å¯æ—¶é€šçŸ¥å‰ç«¯
   - å‰ç«¯è‡ªåŠ¨é‡è¿

3. **å¼€å‘å·¥å…·å¢å¼º**
   - æ·»åŠ å¼€å‘é¢æ¿
   - å®æ—¶æ˜¾ç¤ºè·¯ç”±ä¿¡æ¯
   - æ€§èƒ½ç›‘æ§

4. **å¤šæœåŠ¡æ”¯æŒ**
   - æ”¯æŒå¾®æœåŠ¡å¼€å‘
   - ç‹¬ç«‹çƒ­æ›´æ–°å„ä¸ªæœåŠ¡

